/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var urban = /* color: #ff2002 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-71.38604458963694, 42.301071225602264]),
            {
              "landcover": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.39737424051584, 42.30157907928288]),
            {
              "landcover": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.21747311746897, 42.30030943740097]),
            {
              "landcover": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.08529385721506, 42.33229660620488]),
            {
              "landcover": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.08838376200022, 42.340671511225814]),
            {
              "landcover": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.04615506326975, 42.34600041552782]),
            {
              "landcover": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.26669380721624, 42.393524944521566]),
            {
              "landcover": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.27150032577093, 42.396567526951365]),
            {
              "landcover": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.25708077010687, 42.39276427586597]),
            {
              "landcover": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.09365913924749, 42.36030049197176]),
            {
              "landcover": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0998389488178, 42.35928572831374]),
            {
              "landcover": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.07717964705999, 42.36816435466119]),
            {
              "landcover": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.08438942489202, 42.33035807518012]),
            {
              "landcover": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.08198616561468, 42.32934282809998]),
            {
              "landcover": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.04284737166937, 42.39301783310885]),
            {
              "landcover": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.01572487411077, 42.36638872976965]),
            {
              "landcover": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.06344673690374, 42.36512039554757]),
            {
              "landcover": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.06207344588812, 42.32528167591637]),
            {
              "landcover": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.14790413436468, 42.395046254175035]),
            {
              "landcover": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.48408948955617, 42.30102697628783]),
            {
              "landcover": 0,
              "system:index": "19"
            })]),
    bare = /* color: #eed708 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-71.2151953941303, 42.400117020017404]),
            {
              "landcover": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.19768593368109, 42.401384647454435]),
            {
              "landcover": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.96971962508734, 42.37501272338292]),
            {
              "landcover": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.99066231307562, 42.40518737610729]),
            {
              "landcover": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.02911446151312, 42.39834229858158]),
            {
              "landcover": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.05349037704046, 42.41684764006733]),
            {
              "landcover": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.99615547713812, 42.3876929158942]),
            {
              "landcover": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.08816597518499, 42.33010426494631]),
            {
              "landcover": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.18017647323187, 42.36461305468888]),
            {
              "landcover": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.12833473739202, 42.401891691258555]),
            {
              "landcover": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.21313545760687, 42.39453915505466]),
            {
              "landcover": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.29896614608343, 42.33441889963588]),
            {
              "landcover": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.18489992769578, 42.28166918715358]),
            {
              "landcover": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.19039309175828, 42.27379450617788]),
            {
              "landcover": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.16876375826219, 42.297415596924466]),
            {
              "landcover": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0922027841411, 42.29995497178668]),
            {
              "landcover": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.04551088960984, 42.27887505815428]),
            {
              "landcover": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.01941836031297, 42.2829392048302]),
            {
              "landcover": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.99023592623094, 42.2600749699886]),
            {
              "landcover": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.1471344247661, 42.31112700459862]),
            {
              "landcover": 1,
              "system:index": "19"
            })]),
    water = /* color: #03ffd6 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-70.97491891444999, 42.40712359926287]),
            {
              "landcover": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.04633004726249, 42.37365270977312]),
            {
              "landcover": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0854688412078, 42.35640316501447]),
            {
              "landcover": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15207345546561, 42.436015912426484]),
            {
              "landcover": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15413339198905, 42.38684034233234]),
            {
              "landcover": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.11774118007499, 42.35868646493809]),
            {
              "landcover": 2,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0799756771453, 42.357164274207186]),
            {
              "landcover": 2,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0415235287078, 42.35640316501447]),
            {
              "landcover": 2,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.06692941249686, 42.38709392350621]),
            {
              "landcover": 2,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.02023751796561, 42.388361814010416]),
            {
              "landcover": 2,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.2627917209846, 42.40889807231935]),
            {
              "landcover": 2,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.26519498026194, 42.40408152866983]),
            {
              "landcover": 2,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15601834451975, 42.335342155257976]),
            {
              "landcover": 2,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.20030697977366, 42.327981825925136]),
            {
              "landcover": 2,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.21163663065256, 42.293452928851686]),
            {
              "landcover": 2,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.17696103250803, 42.27694345757278]),
            {
              "landcover": 2,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.00632962381663, 42.28608769927069]),
            {
              "landcover": 2,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.9716540256721, 42.27668943191531]),
            {
              "landcover": 2,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.42930325662913, 42.28481774506077]),
            {
              "landcover": 2,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15807828104319, 42.3358497324285]),
            {
              "landcover": 2,
              "system:index": "19"
            })]),
    vegetation = /* color: #00ff00 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-71.21661813319999, 42.40788409386208]),
            {
              "landcover": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.20700509609061, 42.40788409386208]),
            {
              "landcover": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.20151193202811, 42.3972363304941]),
            {
              "landcover": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15773828090506, 42.40674334850587]),
            {
              "landcover": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.12889916957694, 42.37086266334812]),
            {
              "landcover": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.22983605922538, 42.37821797294527]),
            {
              "landcover": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.11568124355155, 42.448177113740726]),
            {
              "landcover": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.07654244960624, 42.46945353595815]),
            {
              "landcover": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.9920850521453, 42.4886974026716]),
            {
              "landcover": 3,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.15619332851249, 42.32544358161861]),
            {
              "landcover": 3,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.21593148769217, 42.333058007294355]),
            {
              "landcover": 3,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.29146249355155, 42.350313959621616]),
            {
              "landcover": 3,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.27017648280936, 42.40763059668674]),
            {
              "landcover": 3,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.25232369960624, 42.444123642246176]),
            {
              "landcover": 3,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.32098825038749, 42.30614957807768]),
            {
              "landcover": 3,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.2118116146453, 42.27719748220629]),
            {
              "landcover": 3,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.40613229335624, 42.33965643062545]),
            {
              "landcover": 3,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.14246041835624, 42.48312741831091]),
            {
              "landcover": 3,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.0360303646453, 42.49274798889089]),
            {
              "landcover": 3,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.9975782162078, 42.45375020878893]),
            {
              "landcover": 3,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([-70.97903878749686, 42.47958262459705]),
            {
              "landcover": 3,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.30914361537772, 42.32155985334559]),
            {
              "landcover": 3,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.28957421840506, 42.331966646604776]),
            {
              "landcover": 3,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.2967839962371, 42.324352088812304]),
            {
              "landcover": 3,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.29438073695975, 42.31318240343759]),
            {
              "landcover": 3,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.27172143520194, 42.30454992496877]),
            {
              "landcover": 3,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.28476769985038, 42.293884640692085]),
            {
              "landcover": 3,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.31669671596366, 42.286773447622394]),
            {
              "landcover": 3,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.32253320278006, 42.29820175908041]),
            {
              "landcover": 3,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Point([-71.36510522426444, 42.3228290666469]),
            {
              "landcover": 3,
              "system:index": "29"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// switch to landsat satellite
var l8 = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2");
var urbanAreas = ee.FeatureCollection("users/ujavalgandhi/e2e/ne_10m_urban_areas")
            
// Perform supervised classification for your city
// Find the feature id by adding the layer to the map and using Inspector.
var city = urbanAreas.filter(ee.Filter.eq('system:index', '000000000000000012cb'))
var geometry = city.geometry()
Map.centerObject(geometry, 10)

// switched cloud % property name
  //.filter(ee.Filter.lt('CLOUDY COVER', 50))

var filtered = l8.filter(ee.Filter.date('2019-01-01', '2019-12-31'))
  .filter(ee.Filter.bounds(geometry))
  .select('SR_B.*') // changed band name pattern

// Display the input composite.

var rgbVis = {min: 0.0, max: 0.3, bands: ['SR_B4', 'SR_B3', 'SR_B2']};

// Applies scaling factors.
function applyScaleFactors(image) {
  var opticalBands = image.select('SR_B.').multiply(0.0000275).add(-0.2);
  return image.addBands(opticalBands, null, true);}

var filtered = filtered.map(applyScaleFactors);
var composite = filtered.median().clip(geometry) 

Map.addLayer(composite, rgbVis, 'True Color');

// Exercise
// Add training points for 4 classes
// Assign the 'landcover' property as follows

// urban: 0
// bare: 1
// water: 2
// vegetation: 3

var gcp = urban.merge(bare).merge(water).merge(vegetation)

// ADDING IN ACCURACY ASSESSMENT
// Add a random column and split the GCPs into training and validation set
var gcp = gcp.randomColumn()


// ADDING IN INDICES - changed bands from original example to fit landsat
var addIndices = function(image) {
  var ndvi = image.normalizedDifference(['SR_B5', 'SR_B4']).rename(['ndvi']);
  var ndbi = image.normalizedDifference(['SR_B6', 'SR_B5']).rename(['ndbi']);
  var mndwi = image.normalizedDifference(['SR_B3', 'SR_B6']).rename(['mndwi']);
  return image.addBands(ndvi).addBands(ndbi).addBands(mndwi);
};

var composite = addIndices(composite);

// This being a simpler classification, we take 60% points
// for validation. Normal recommended ratio is
// 70% training, 30% validation
var trainingGcp = gcp.filter(ee.Filter.lt('random', 0.6));
var validationGcp = gcp.filter(ee.Filter.gte('random', 0.6));

// Overlay the point on the image to get training data.
var training = composite.sampleRegions({
  collection: trainingGcp, 
  properties: ['landcover'], 
  scale: 10,
  tileScale: 16
});
print(training)


// Train a classifier. switched from Random Forest w 50 trees to Cart
var classifier = ee.Classifier.smileCart().train({
  features: training,  
  classProperty: 'landcover', 
  inputProperties: composite.bandNames()
});
// // Classify the image.
var classified = composite.classify(classifier);
Map.addLayer(classified, {min: 0, max: 3, palette: ['gray', 'brown', 'blue', 'green']}, '2019'); 

// Use classification map to assess accuracy using the validation fraction
// of the overall training set created above.
var test = classified.sampleRegions({
  collection: validationGcp,
  properties: ['landcover'],
  tileScale: 16,
  scale: 10,
});

var testConfusionMatrix = test.errorMatrix('landcover', 'classification');
// Printing of confusion matrix may time out. Alternatively, you can export it as CSV
print('Confusion Matrix', testConfusionMatrix);
print('Test Accuracy', testConfusionMatrix.accuracy());

// accuracy without indices: 89.7%
// accuracy with indices: 89.7%
